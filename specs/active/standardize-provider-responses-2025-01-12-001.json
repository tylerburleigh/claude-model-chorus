{
  "spec_id": "standardize-provider-responses-2025-01-12-001",
  "generated": "2025-01-12T10:00:00Z",
  "last_updated": "2025-11-13T16:00:37.585680Z",
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "Standardize Provider JSON Responses with Thread ID Support",
      "status": "in_progress",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4",
        "phase-5",
        "phase-6"
      ],
      "total_tasks": 38,
      "completed_tasks": 1,
      "metadata": {
        "description": "Standardize all provider responses to use structured dataclasses (TokenUsage, enhanced GenerationResponse) with thread_id field for conversation continuation. Extract CLI-native session/thread IDs from Claude, Codex, and Cursor Agent.",
        "scope": "Extract and store thread IDs only. CLI continuation (--resume flag usage) deferred to future spec.",
        "providers_affected": [
          "claude",
          "codex",
          "cursor-agent",
          "gemini"
        ]
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Core Data Structures with Thread ID Support",
      "status": "in_progress",
      "parent": "spec-root",
      "children": [
        "phase-1-files",
        "phase-1-verify"
      ],
      "total_tasks": 6,
      "completed_tasks": 1,
      "metadata": {
        "purpose": "Create foundational dataclasses with thread_id field",
        "risk_level": "low"
      },
      "dependencies": {
        "blocks": [
          "phase-2",
          "phase-3",
          "phase-4",
          "phase-5"
        ]
      }
    },
    "phase-1-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "in_progress",
      "parent": "phase-1",
      "children": [
        "task-1-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 1,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-1-verify"
        ]
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "model_chorus/src/model_chorus/providers/base_provider.py",
      "status": "in_progress",
      "parent": "phase-1-files",
      "children": [
        "task-1-1-1",
        "task-1-1-2",
        "task-1-1-3",
        "task-1-1-4",
        "task-1-1-5"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 5,
      "completed_tasks": 1,
      "metadata": {
        "file_path": "model_chorus/src/model_chorus/providers/base_provider.py",
        "task_category": "implementation",
        "estimated_hours": 3
      }
    },
    "task-1-1-1": {
      "type": "subtask",
      "title": "Create TokenUsage dataclass with explicit token fields",
      "status": "completed",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-1-1-2",
          "task-1-1-3"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 1,
      "metadata": {
        "details": "Add @dataclass with fields: input_tokens, output_tokens, cached_input_tokens, total_tokens (all int=0), metadata (Dict[str,Any])",
        "started_at": "2025-11-13T15:59:18.912240Z",
        "completed_at": "2025-11-13T16:00:37.581674Z",
        "needs_journaling": false,
        "actual_hours": 0.022,
        "journaled_at": "2025-11-13T16:00:37.584623Z"
      }
    },
    "task-1-1-2": {
      "type": "subtask",
      "title": "Add dict-like access methods to TokenUsage for backward compatibility",
      "status": "pending",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-1-1-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Implement __getitem__, __setitem__, get() methods to support usage['input_tokens'] alongside usage.input_tokens",
        "task_category": "implementation"
      }
    },
    "task-1-1-3": {
      "type": "subtask",
      "title": "Update GenerationResponse to use TokenUsage instead of Dict",
      "status": "pending",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-1-1-4"
        ],
        "blocked_by": [
          "task-1-1-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Replace 'usage: Dict[str, int]' with 'usage: TokenUsage = field(default_factory=TokenUsage)'",
        "task_category": "implementation"
      }
    },
    "task-1-1-4": {
      "type": "subtask",
      "title": "Add new fields to GenerationResponse",
      "status": "pending",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-1-1-5"
        ],
        "blocked_by": [
          "task-1-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Add: thread_id: Optional[str] = None, provider: Optional[str] = None, stderr: Optional[str] = None, duration_ms: Optional[int] = None, raw_response: Optional[Dict[str, Any]] = None",
        "task_category": "implementation"
      }
    },
    "task-1-1-5": {
      "type": "subtask",
      "title": "Add docstrings documenting thread_id field and provider mappings",
      "status": "pending",
      "parent": "task-1-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-1-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Document that thread_id maps from session_id (Claude, Cursor) or thread_id (Codex), null for Gemini",
        "task_category": "investigation",
        "file_path": "investigation"
      }
    },
    "phase-1-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-1",
      "children": [
        "verify-1-1"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-1-files"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Verify base_provider.py changes compile and type-check",
      "status": "pending",
      "parent": "phase-1-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "auto",
        "command": "cd model_chorus && python -m py_compile src/model_chorus/providers/base_provider.py",
        "expected": "No syntax errors"
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Claude Provider Standardization with Session ID",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-2-files",
        "phase-2-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-6"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      },
      "total_tasks": 8,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Update Claude provider to extract session_id and use new structures",
        "risk_level": "low-medium"
      }
    },
    "phase-2-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-2",
      "children": [
        "task-2-1"
      ],
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-2-verify"
        ]
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "model_chorus/src/model_chorus/providers/claude_provider.py",
      "status": "pending",
      "parent": "phase-2-files",
      "children": [
        "task-2-1-1",
        "task-2-1-2",
        "task-2-1-3",
        "task-2-1-4",
        "task-2-1-5",
        "task-2-1-6"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "model_chorus/src/model_chorus/providers/claude_provider.py",
        "task_category": "implementation",
        "estimated_hours": 2
      }
    },
    "task-2-1-1": {
      "type": "subtask",
      "title": "Import TokenUsage from base_provider",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-2-1-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Add TokenUsage to imports at top of file"
      }
    },
    "task-2-1-2": {
      "type": "subtask",
      "title": "Update parse_response to create TokenUsage object",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-2-1-4"
        ],
        "blocked_by": [
          "task-2-1-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Replace usage dict creation with TokenUsage(input_tokens=..., output_tokens=..., cached_input_tokens=..., total_tokens=..., metadata={modelUsage, duration_ms, total_cost_usd})",
        "task_category": "implementation"
      }
    },
    "task-2-1-3": {
      "type": "subtask",
      "title": "Extract session_id from CLI response",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-2-1-4"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Extract data.get('session_id') from parsed JSON response"
      }
    },
    "task-2-1-4": {
      "type": "subtask",
      "title": "Update GenerationResponse construction with new fields",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-2-1-5"
        ],
        "blocked_by": [
          "task-2-1-2",
          "task-2-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Add: thread_id=session_id, provider='claude', stderr=stderr, duration_ms=data.get('duration_ms'), raw_response=data",
        "task_category": "implementation"
      }
    },
    "task-2-1-5": {
      "type": "subtask",
      "title": "Move provider-specific data to metadata",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-2-1-6"
        ],
        "blocked_by": [
          "task-2-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Keep metadata empty at top-level (modelUsage, duration_ms, cost now in usage.metadata or raw_response)",
        "task_category": "implementation"
      }
    },
    "task-2-1-6": {
      "type": "subtask",
      "title": "Update comments/docstrings to reflect new structure",
      "status": "pending",
      "parent": "task-2-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-2-1-5"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Update parse_response docstring showing new response structure",
        "task_category": "implementation"
      }
    },
    "phase-2-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-2",
      "children": [
        "verify-2-1",
        "verify-2-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-2-files"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Manual test: Parse Claude CLI output",
      "status": "pending",
      "parent": "phase-2-verify",
      "children": [],
      "dependencies": {
        "blocks": [
          "verify-2-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Run 'claude -p \"test\" --output-format json' and pass output through parse_response. Verify: TokenUsage created, session_id extracted to thread_id, all fields populated",
        "command": "",
        "expected": ""
      }
    },
    "verify-2-2": {
      "type": "verify",
      "title": "Verify backward compatibility with dict access",
      "status": "pending",
      "parent": "phase-2-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "verify-2-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Test both response.usage.input_tokens and response.usage['input_tokens'] work correctly",
        "command": "",
        "expected": ""
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Codex Provider Standardization with Thread ID",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-3-files",
        "phase-3-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-6"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": [
          "phase-2"
        ]
      },
      "total_tasks": 7,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Update Codex provider to move thread_id to top-level and use new structures",
        "risk_level": "low-medium"
      }
    },
    "phase-3-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-3",
      "children": [
        "task-3-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-3-verify"
        ]
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "model_chorus/src/model_chorus/providers/codex_provider.py",
      "status": "pending",
      "parent": "phase-3-files",
      "children": [
        "task-3-1-1",
        "task-3-1-2",
        "task-3-1-3",
        "task-3-1-4",
        "task-3-1-5"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "model_chorus/src/model_chorus/providers/codex_provider.py",
        "task_category": "implementation",
        "estimated_hours": 2
      }
    },
    "task-3-1-1": {
      "type": "subtask",
      "title": "Import TokenUsage from base_provider",
      "status": "pending",
      "parent": "task-3-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-3-1-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {}
    },
    "task-3-1-2": {
      "type": "subtask",
      "title": "Update parse_response to create TokenUsage object from JSONL events",
      "status": "pending",
      "parent": "task-3-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-3-1-4"
        ],
        "blocked_by": [
          "task-3-1-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Extract usage from turn.completed event, create TokenUsage with cached_input_tokens support",
        "task_category": "implementation"
      }
    },
    "task-3-1-3": {
      "type": "subtask",
      "title": "Move thread_id from metadata to top-level field",
      "status": "pending",
      "parent": "task-3-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-3-1-4"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Change from metadata={'thread_id': thread_id} to thread_id=thread_id as parameter"
      }
    },
    "task-3-1-4": {
      "type": "subtask",
      "title": "Update GenerationResponse construction with new fields",
      "status": "pending",
      "parent": "task-3-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-3-1-5"
        ],
        "blocked_by": [
          "task-3-1-2",
          "task-3-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Add: thread_id=thread_id, provider='codex', stderr=stderr, raw_response={'events': events}",
        "task_category": "implementation"
      }
    },
    "task-3-1-5": {
      "type": "subtask",
      "title": "Update comments/docstrings",
      "status": "pending",
      "parent": "task-3-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-3-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation"
      }
    },
    "phase-3-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-3",
      "children": [
        "verify-3-1",
        "verify-3-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-3-files"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Manual test: Parse Codex CLI JSONL output",
      "status": "pending",
      "parent": "phase-3-verify",
      "children": [],
      "dependencies": {
        "blocks": [
          "verify-3-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Run 'codex exec --json --sandbox read-only \"test\"' and parse output. Verify: TokenUsage created, thread_id at top-level, cached_input_tokens tracked",
        "command": "",
        "expected": ""
      }
    },
    "verify-3-2": {
      "type": "verify",
      "title": "Verify thread_id accessible at top-level (not in metadata)",
      "status": "pending",
      "parent": "phase-3-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "verify-3-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Test response.thread_id works (not response.metadata['thread_id'])",
        "command": "",
        "expected": ""
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Cursor Agent Provider Standardization with Session ID",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-4-files",
        "phase-4-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-6"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": [
          "phase-2"
        ]
      },
      "total_tasks": 7,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Update Cursor Agent provider to extract session_id and use new structures",
        "risk_level": "low-medium"
      }
    },
    "phase-4-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-4",
      "children": [
        "task-4-1"
      ],
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-4-verify"
        ]
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "model_chorus/src/model_chorus/providers/cursor_agent_provider.py",
      "status": "pending",
      "parent": "phase-4-files",
      "children": [
        "task-4-1-1",
        "task-4-1-2",
        "task-4-1-3",
        "task-4-1-4",
        "task-4-1-5"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 5,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "model_chorus/src/model_chorus/providers/cursor_agent_provider.py",
        "task_category": "implementation",
        "estimated_hours": 2
      }
    },
    "task-4-1-1": {
      "type": "subtask",
      "title": "Import TokenUsage from base_provider",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-4-1-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {}
    },
    "task-4-1-2": {
      "type": "subtask",
      "title": "Update parse_response to create TokenUsage object",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-4-1-4"
        ],
        "blocked_by": [
          "task-4-1-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Create TokenUsage from usage dict in response",
        "task_category": "implementation"
      }
    },
    "task-4-1-3": {
      "type": "subtask",
      "title": "Extract session_id from CLI response",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-4-1-4"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Extract data.get('session_id') from parsed JSON"
      }
    },
    "task-4-1-4": {
      "type": "subtask",
      "title": "Update GenerationResponse construction with new fields",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-4-1-5"
        ],
        "blocked_by": [
          "task-4-1-2",
          "task-4-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Add: thread_id=session_id, provider='cursor-agent', stderr=stderr, raw_response=data. Keep code_blocks, language in metadata",
        "task_category": "implementation"
      }
    },
    "task-4-1-5": {
      "type": "subtask",
      "title": "Update comments/docstrings",
      "status": "pending",
      "parent": "task-4-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-4-1-4"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "task_category": "implementation"
      }
    },
    "phase-4-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-4",
      "children": [
        "verify-4-1",
        "verify-4-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-4-files"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Manual test: Parse Cursor Agent CLI output",
      "status": "pending",
      "parent": "phase-4-verify",
      "children": [],
      "dependencies": {
        "blocks": [
          "verify-4-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Run 'cursor-agent -p \"test\" --output-format json' and parse. Verify: TokenUsage created, session_id extracted to thread_id",
        "command": "",
        "expected": ""
      }
    },
    "verify-4-2": {
      "type": "verify",
      "title": "Verify code_blocks and language metadata preserved",
      "status": "pending",
      "parent": "phase-4-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "verify-4-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Check response.metadata contains code_blocks and language fields",
        "command": "",
        "expected": ""
      }
    },
    "phase-5": {
      "type": "phase",
      "title": "Gemini Provider Standardization (App-Level Only)",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-5-files",
        "phase-5-verify"
      ],
      "dependencies": {
        "blocks": [
          "phase-6"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": [
          "phase-2"
        ]
      },
      "total_tasks": 6,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Update Gemini provider to use new structures (no thread_id support)",
        "risk_level": "low"
      }
    },
    "phase-5-files": {
      "type": "group",
      "title": "File Modifications",
      "status": "pending",
      "parent": "phase-5",
      "children": [
        "task-5-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {},
      "dependencies": {
        "blocks": [
          "phase-5-verify"
        ]
      }
    },
    "task-5-1": {
      "type": "task",
      "title": "model_chorus/src/model_chorus/providers/gemini_provider.py",
      "status": "pending",
      "parent": "phase-5-files",
      "children": [
        "task-5-1-1",
        "task-5-1-2",
        "task-5-1-3",
        "task-5-1-4"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "file_path": "model_chorus/src/model_chorus/providers/gemini_provider.py",
        "task_category": "implementation",
        "estimated_hours": 2
      }
    },
    "task-5-1-1": {
      "type": "subtask",
      "title": "Import TokenUsage from base_provider",
      "status": "pending",
      "parent": "task-5-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-5-1-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {}
    },
    "task-5-1-2": {
      "type": "subtask",
      "title": "Update parse_response to create TokenUsage with normalized field names",
      "status": "pending",
      "parent": "task-5-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-5-1-3"
        ],
        "blocked_by": [
          "task-5-1-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Map: tokens['prompt'] \u2192 input_tokens, tokens['candidates'] \u2192 output_tokens, tokens['total'] \u2192 total_tokens. Store stats in usage.metadata",
        "task_category": "implementation"
      }
    },
    "task-5-1-3": {
      "type": "subtask",
      "title": "Update GenerationResponse construction with new fields",
      "status": "pending",
      "parent": "task-5-1",
      "children": [],
      "dependencies": {
        "blocks": [
          "task-5-1-4"
        ],
        "blocked_by": [
          "task-5-1-2"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Add: thread_id=None (Gemini has no CLI thread support), provider='gemini', stderr=stderr, raw_response=data. Keep stats in metadata",
        "task_category": "implementation"
      }
    },
    "task-5-1-4": {
      "type": "subtask",
      "title": "Update comments/docstrings noting lack of thread support",
      "status": "pending",
      "parent": "task-5-1",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "task-5-1-3"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "details": "Document that Gemini relies on app-level ConversationMemory for continuation",
        "task_category": "implementation"
      }
    },
    "phase-5-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-5",
      "children": [
        "verify-5-1",
        "verify-5-2"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-5-files"
        ],
        "depends": []
      },
      "total_tasks": 2,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-5-1": {
      "type": "verify",
      "title": "Manual test: Parse Gemini CLI output",
      "status": "pending",
      "parent": "phase-5-verify",
      "children": [],
      "dependencies": {
        "blocks": [
          "verify-5-2"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Run 'gemini -p \"test\" --output-format json' and parse. Verify: TokenUsage created with normalized names (prompt\u2192input_tokens), thread_id is None",
        "command": "",
        "expected": ""
      }
    },
    "verify-5-2": {
      "type": "verify",
      "title": "Verify stats preserved in metadata",
      "status": "pending",
      "parent": "phase-5-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "verify-5-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Check response.metadata['stats'] contains full Gemini stats object",
        "command": "",
        "expected": ""
      }
    },
    "phase-6": {
      "type": "phase",
      "title": "Testing & Validation",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "phase-6-verify"
      ],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-2",
          "phase-3",
          "phase-4",
          "phase-5"
        ],
        "depends": []
      },
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "Verify all changes work correctly including thread ID handling",
        "risk_level": "low"
      }
    },
    "phase-6-verify": {
      "type": "group",
      "title": "Verification",
      "status": "pending",
      "parent": "phase-6",
      "children": [
        "verify-6-1",
        "verify-6-2",
        "verify-6-3",
        "verify-6-4"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {}
    },
    "verify-6-1": {
      "type": "verify",
      "title": "Verify backward compatibility with existing workflow code",
      "status": "pending",
      "parent": "phase-6-verify",
      "children": [],
      "dependencies": {
        "blocks": [
          "verify-6-3"
        ],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Test existing workflow code (consensus.py, chat.py) still works. Verify usage['input_tokens'] dict access works alongside usage.input_tokens",
        "command": "",
        "expected": ""
      }
    },
    "verify-6-2": {
      "type": "verify",
      "title": "Verify thread_id extraction for all providers",
      "status": "pending",
      "parent": "phase-6-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Test each provider and verify: Claude (session_id\u2192thread_id), Codex (thread_id\u2192thread_id), Cursor (session_id\u2192thread_id), Gemini (thread_id=None)",
        "command": "",
        "expected": ""
      }
    },
    "verify-6-3": {
      "type": "verify",
      "title": "Verify app-level ConversationMemory still works",
      "status": "pending",
      "parent": "phase-6-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "verify-6-1"
        ],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "manual",
        "steps": "Test creating threads with ConversationMemory, verify continuation_id parameter still works for app-level threading (especially for Gemini)",
        "command": "",
        "expected": ""
      }
    },
    "verify-6-4": {
      "type": "verify",
      "title": "Phase 6 implementation fidelity review",
      "status": "pending",
      "parent": "phase-6-verify",
      "children": [],
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      },
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "verification_type": "fidelity",
        "skill": "sdd-fidelity-review",
        "scope": "spec",
        "target": "spec-root",
        "on_failure": {
          "consult": true,
          "revert_status": "in_progress",
          "continue_on_failure": false
        },
        "agent": "sdd-fidelity-review"
      }
    }
  },
  "metadata": {
    "status": "active",
    "activated_date": "2025-11-13T15:53:43.490176Z",
    "progress_percentage": 2,
    "current_phase": "phase-1"
  },
  "journal": [
    {
      "timestamp": "2025-11-13T16:00:37.584619Z",
      "entry_type": "status_change",
      "title": "Task Completed: Create TokenUsage dataclass with explicit token fields",
      "author": "claude-code",
      "content": "Successfully created TokenUsage dataclass in base_provider.py with all required fields (input_tokens, output_tokens, cached_input_tokens, total_tokens, metadata). Added comprehensive docstring explaining each field's purpose. Verified import and instantiation work correctly with multiple test cases including default values, explicit values, and metadata. The dataclass follows existing code style and is positioned logically between GenerationRequest and GenerationResponse. All success criteria met.",
      "metadata": {},
      "task_id": "task-1-1-1"
    }
  ]
}